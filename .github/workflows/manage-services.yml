name: Manage Services

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Service action'
        required: true
        type: choice
        options:
          - restart-all
          - restart-monitoring
          - stop-monitoring
          - logs-monitoring
      service:
        description: 'Specific service (optional)'
        required: false
        type: string

jobs:
  manage:
    name: Manage Services on GCP
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.GCP_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Restart All Services
        if: github.event.inputs.action == 'restart-all'
        run: |
          ssh ubuntu@${{ secrets.GCP_INSTANCE_IP }} << 'EOF'
            cd ~/docker/monitoring && docker compose restart
            echo "âœ… All services restarted"
          EOF

      - name: Restart Monitoring Stack
        if: github.event.inputs.action == 'restart-monitoring'
        run: |
          ssh ubuntu@${{ secrets.GCP_INSTANCE_IP }} << 'EOF'
            cd ~/docker/monitoring
            docker compose restart
            echo "âœ… Monitoring stack restarted"
          EOF

      - name: Stop Monitoring Stack
        if: github.event.inputs.action == 'stop-monitoring'
        run: |
          ssh ubuntu@${{ secrets.GCP_INSTANCE_IP }} << 'EOF'
            cd ~/docker/monitoring
            docker compose down
            echo "ðŸ›‘ Monitoring stack stopped"
          EOF

      - name: View Monitoring Logs
        if: github.event.inputs.action == 'logs-monitoring'
        run: |
          ssh ubuntu@${{ secrets.GCP_INSTANCE_IP }} << 'EOF'
            cd ~/docker/monitoring
            docker compose logs --tail=100
          EOF

      - name: Summary
        run: |
          echo "Action completed: ${{ github.event.inputs.action }}"
          echo "Service: ${{ github.event.inputs.service || 'all' }}"
