name: Deploy Application

on:
  push:
    branches:
      - main
    paths:
      - 'files/**'
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    name: Deploy to GCP Instance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.GCP_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Deploy Files to Server
        run: |
          # Deploy scripts
          scp -r files/scripts/* ubuntu@${{ secrets.GCP_INSTANCE_IP }}:~/scripts/

          # Deploy docker configs
          scp -r files/docker/* ubuntu@${{ secrets.GCP_INSTANCE_IP }}:~/docker/

          # Deploy config files
          scp -r files/configs/* ubuntu@${{ secrets.GCP_INSTANCE_IP }}:~/configs/

      - name: Set Permissions
        run: |
          ssh ubuntu@${{ secrets.GCP_INSTANCE_IP }} "chmod +x ~/scripts/*.sh"

      - name: Deploy Monitoring Stack
        if: contains(github.event.head_commit.message, '[deploy-monitoring]') || github.event_name == 'workflow_dispatch'
        run: |
          ssh ubuntu@${{ secrets.GCP_INSTANCE_IP }} << 'EOF'
            cd ~/docker/monitoring
            # Copy all config files
            cp ~/configs/prometheus/prometheus.yml .
            cp ~/configs/loki/loki-config.yaml .
            cp ~/configs/alloy/config.alloy .
            cp ~/configs/grafana/datasources.yml .
            # Deploy
            docker compose up -d
            echo "âœ… Monitoring stack (Prometheus + Grafana + Loki + Alloy) deployed successfully"
          EOF

      - name: Deployment Summary
        run: |
          echo "âœ… Files deployed successfully to GCP instance"
          echo "ðŸ“¦ Scripts: files/scripts/"
          echo "ðŸ³ Docker: files/docker/"
          echo "âš™ï¸  Configs: files/configs/"
